<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administrador de Equipos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            color: #ffffff;
        }
        .container {
            min-height: 100vh;
        }
        .input-group input, .input-group button, .input-group select, textarea {
            border-radius: 9999px;
            padding: 0.75rem 1.5rem;
            outline: none;
            transition: all 0.3s ease;
        }
        .input-group input:focus, .input-group select:focus, textarea:focus {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5);
        }
        .form-input {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: #ffffff;
        }
        .table-container {
            max-height: 60vh;
            overflow-y: auto;
        }
        /* Estilos para el scrollbar */
        .table-container::-webkit-scrollbar {
            width: 8px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 10px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 10px;
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #5a667b;
        }
        textarea {
            border-radius: 1rem;
            resize: vertical;
            height: 10rem;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #1a1a2e;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
        }
        .modal-message {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center p-6">
    <!-- Contenedor para la autenticación -->
    <div id="authContainer" class="container bg-gray-800 p-8 rounded-2xl shadow-lg w-full max-w-sm text-center space-y-4">
        <h2 class="text-2xl font-bold text-indigo-400">Acceso de Administrador</h2>
        <p class="text-gray-400">Por favor, ingresa la contraseña para continuar.</p>
        <input type="password" id="passwordInput" placeholder="Contraseña" class="form-input w-full">
        <button id="loginButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-full transition-colors w-full">Entrar</button>
        <div id="authMessage" class="text-red-400 font-semibold hidden">Contraseña incorrecta.</div>
    </div>

    <!-- Contenedor principal de la aplicación, visible solo con la contraseña correcta -->
    <div id="appContainer" class="container bg-gray-800 p-8 rounded-2xl shadow-lg w-full max-w-5xl space-y-8 hidden">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-center text-indigo-400">Panel de Administración de Equipos</h1>
            <button id="logoutButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-full transition-colors">Cerrar Sesión</button>
        </div>

        <!-- Enlace a la página de visualización -->
        <div class="text-center">
            <a href="index.html" class="text-blue-400 hover:text-blue-300 transition-colors">Ir al Buscador para Técnicos</a>
        </div>

        <!-- Formulario para agregar/editar equipos individualmente -->
        <div class="bg-gray-700 p-6 rounded-xl shadow-md space-y-4">
            <h2 class="text-xl font-semibold text-indigo-300">Agregar/Editar Equipo (Individual)</h2>
            <form id="equipmentForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <input type="text" id="tipoInput" placeholder="Tipo" class="form-input" required>
                <input type="text" id="modeloInput" placeholder="Modelo" class="form-input" required>
                <input type="text" id="serieInput" placeholder="Número de Serie" class="form-input" required>
                <input type="text" id="proyectoInput" placeholder="Proyecto" class="form-input" required>
                <button type="submit" id="submitButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-full transition-colors col-span-1 md:col-span-2 lg:col-span-4">Agregar Equipo</button>
            </form>
        </div>

        <!-- Formulario para carga masiva -->
        <div class="bg-gray-700 p-6 rounded-xl shadow-md space-y-4">
            <h2 class="text-xl font-semibold text-indigo-300">Carga Masiva</h2>
            <p class="text-gray-400">Pega los datos de tu hoja de cálculo aquí. El formato debe ser: <br> `Tipo	Modelo	Serie	Proyecto`</p>
            <textarea id="bulkDataInput" placeholder="Pega los datos aquí..." class="form-input w-full"></textarea>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="bulkImportButton" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-full transition-colors w-full">Importar Equipos</button>
            </div>
        </div>

        <!-- Tabla de equipos existentes -->
        <div class="table-container bg-gray-700 p-6 rounded-xl shadow-md">
            <h2 class="text-2xl font-semibold mb-4 text-center text-indigo-300">Equipos Registrados</h2>
            <div class="mb-4 flex justify-between items-center">
                <label for="selectAllCheckbox" class="text-sm">
                    <input type="checkbox" id="selectAllCheckbox" class="rounded text-indigo-600 focus:ring-indigo-500">
                    Seleccionar todos
                </label>
                <button id="deleteSelectedButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-full transition-colors">Eliminar Seleccionados</button>
            </div>
            <table class="w-full text-left table-auto">
                <thead>
                    <tr class="bg-gray-600 rounded-lg">
                        <th class="p-3"></th>
                        <th class="p-3 rounded-tl-lg">Tipo</th>
                        <th class="p-3">Modelo</th>
                        <th class="p-3">Serie</th>
                        <th class="p-3">Proyecto</th>
                        <th class="p-3 rounded-tr-lg">Acciones</th>
                    </tr>
                </thead>
                <tbody id="equipmentTableBody">
                    <!-- Filas de equipos se insertan aquí -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal para alertas y confirmaciones -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <p id="modal-message" class="modal-message"></p>
            <div id="modal-actions" class="flex gap-4 justify-center">
                <button id="modal-ok" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-full transition-colors">OK</button>
                <button id="modal-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-6 rounded-full transition-colors hidden">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // Contenedor de elementos HTML
        const authContainer = document.getElementById('authContainer');
        const passwordInput = document.getElementById('passwordInput');
        const loginButton = document.getElementById('loginButton');
        const authMessage = document.getElementById('authMessage');
        const appContainer = document.getElementById('appContainer');
        const form = document.getElementById('equipmentForm');
        const tipoInput = document.getElementById('tipoInput');
        const modeloInput = document.getElementById('modeloInput');
        const serieInput = document.getElementById('serieInput');
        const proyectoInput = document.getElementById('proyectoInput');
        const submitButton = document.getElementById('submitButton');
        const tableBody = document.getElementById('equipmentTableBody');
        const bulkDataInput = document.getElementById('bulkDataInput');
        const bulkImportButton = document.getElementById('bulkImportButton');
        const deleteSelectedButton = document.getElementById('deleteSelectedButton');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const logoutButton = document.getElementById('logoutButton');

        // Modal elements
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modal-message');
        const modalOk = document.getElementById('modal-ok');
        const modalCancel = document.getElementById('modal-cancel');

        // Variables de estado
        let isEditing = false;
        let originalSerie = null;
        const correctPassword = 'admfcom2025';

        // Modal functions
        const showModal = (message, isConfirmation = false, onConfirm = null, onCancel = null) => {
            modalMessage.textContent = message;
            modalOk.textContent = isConfirmation ? 'Sí' : 'OK';
            modalCancel.classList.toggle('hidden', !isConfirmation);
            modal.style.display = 'flex';

            if (isConfirmation) {
                modalOk.onclick = () => {
                    hideModal();
                    if (onConfirm) onConfirm();
                };
                modalCancel.onclick = () => {
                    hideModal();
                    if (onCancel) onCancel();
                };
            } else {
                modalOk.onclick = hideModal;
                modalCancel.onclick = null;
            }
        };

        const hideModal = () => {
            modal.style.display = 'none';
        };
        
        // Funciones de la base de datos (localStorage)
        const getEquipos = () => {
            const equipos = localStorage.getItem('equipos');
            return equipos ? JSON.parse(equipos) : [];
        };

        const saveEquipos = (equipos) => {
            localStorage.setItem('equipos', JSON.stringify(equipos));
        };

        const deleteSelectedEquipos = () => {
            const selectedSeries = Array.from(document.querySelectorAll('.equipo-checkbox:checked')).map(cb => cb.dataset.serie);
            if (selectedSeries.length === 0) {
                showModal('Por favor, selecciona al menos un equipo para eliminar.');
                return;
            }

            showModal(`¿Estás seguro de que quieres eliminar ${selectedSeries.length} equipo(s)?`, true, () => {
                let equipos = getEquipos();
                equipos = equipos.filter(equipo => !selectedSeries.includes(equipo.serie));
                saveEquipos(equipos);
                renderTable();
                showModal('Equipos eliminados.');
            });
        };

        // Renderiza la tabla de equipos
        const renderTable = () => {
            const equipos = getEquipos();
            tableBody.innerHTML = '';
            if (equipos.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-400">No hay equipos registrados.</td></tr>';
                return;
            }
            equipos.forEach(equipo => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-600 last:border-0';
                row.innerHTML = `
                    <td class="p-3">
                        <input type="checkbox" class="equipo-checkbox rounded text-indigo-600 focus:ring-indigo-500" data-serie="${equipo.serie}">
                    </td>
                    <td class="p-3">${equipo.tipo}</td>
                    <td class="p-3">${equipo.modelo}</td>
                    <td class="p-3">${equipo.serie}</td>
                    <td class="p-3">${equipo.proyecto}</td>
                    <td class="p-3 flex gap-2">
                        <button class="edit-btn text-blue-400 hover:text-blue-300 transition-colors" data-serie="${equipo.serie}">Editar</button>
                        <button class="delete-btn text-red-400 hover:text-red-300 transition-colors" data-serie="${equipo.serie}">Eliminar</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            addEventListeners();
        };

        const addEventListeners = () => {
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => editEquipo(e.target.dataset.serie));
            });
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => deleteEquipo(e.target.dataset.serie));
            });
            document.querySelectorAll('.equipo-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const allChecked = Array.from(document.querySelectorAll('.equipo-checkbox')).every(cb => cb.checked);
                    selectAllCheckbox.checked = allChecked;
                });
            });
        };

        const addOrUpdateEquipo = (e) => {
            e.preventDefault();
            const tipo = tipoInput.value.trim();
            const modelo = modeloInput.value.trim();
            const serie = serieInput.value.trim();
            const proyecto = proyectoInput.value.trim();

            if (!tipo || !modelo || !serie || !proyecto) {
                showModal('Todos los campos son obligatorios.');
                return;
            }

            let equipos = getEquipos();
            if (isEditing) {
                const index = equipos.findIndex(eq => eq.serie === originalSerie);
                if (index !== -1) {
                    equipos[index] = { tipo, modelo, serie, proyecto };
                    saveEquipos(equipos);
                    showModal('Equipo actualizado exitosamente.');
                }
                isEditing = false;
                originalSerie = null;
                submitButton.textContent = 'Agregar Equipo';
            } else {
                const existingEquipo = equipos.find(eq => eq.serie === serie);
                if (existingEquipo) {
                    showModal('Un equipo con este número de serie ya existe.');
                    return;
                }
                equipos.push({ tipo, modelo, serie, proyecto });
                saveEquipos(equipos);
                showModal('Equipo agregado exitosamente.');
            }
            form.reset();
            renderTable();
        };

        const editEquipo = (serie) => {
            const equipos = getEquipos();
            const equipo = equipos.find(eq => eq.serie === serie);
            if (equipo) {
                tipoInput.value = equipo.tipo;
                modeloInput.value = equipo.modelo;
                serieInput.value = equipo.serie;
                proyectoInput.value = equipo.proyecto;
                isEditing = true;
                originalSerie = serie;
                submitButton.textContent = 'Actualizar Equipo';
            }
        };

        const deleteEquipo = (serie) => {
            showModal('¿Estás seguro de que quieres eliminar este equipo?', true, () => {
                let equipos = getEquipos();
                equipos = equipos.filter(eq => eq.serie !== serie);
                saveEquipos(equipos);
                renderTable();
                showModal('Equipo eliminado.');
            });
        };

        const handleBulkImport = () => {
            const rawData = bulkDataInput.value.trim();
            if (!rawData) {
                showModal('Por favor, pega los datos en el área de texto.');
                return;
            }

            const newEquipos = [];
            const lines = rawData.split('\n');
            const existingEquipos = getEquipos();
            const existingSeries = new Set(existingEquipos.map(e => e.serie));
            let duplicatesFound = 0;

            lines.forEach(line => {
                const fields = line.split('\t').map(field => field.trim());
                if (fields.length >= 4) {
                    const [tipo, modelo, serie, proyecto] = fields;
                    if (serie && !existingSeries.has(serie)) {
                        newEquipos.push({ tipo, modelo, serie, proyecto });
                        existingSeries.add(serie);
                    } else if (serie) {
                        duplicatesFound++;
                    }
                }
            });

            if (newEquipos.length > 0) {
                const updatedEquipos = [...existingEquipos, ...newEquipos];
                saveEquipos(updatedEquipos);
                renderTable();
                showModal(`Importación exitosa. Se agregaron ${newEquipos.length} equipos. ${duplicatesFound} duplicados fueron omitidos.`);
                bulkDataInput.value = '';
            } else {
                showModal('No se agregaron nuevos equipos. Asegúrate de que los datos tengan el formato correcto y que no haya duplicados.');
            }
        };
        
        const handleLogout = () => {
            localStorage.removeItem('isAuthenticated');
            showAuth();
        };

        // Lógica de autenticación
        const checkAuth = () => {
            const isAuthenticated = localStorage.getItem('isAuthenticated');
            if (isAuthenticated === 'true') {
                showApp();
            } else {
                showAuth();
            }
        };

        const showAuth = () => {
            authContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
        };

        const showApp = () => {
            authContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            renderTable(); // Renderiza la tabla solo una vez autenticado
        };

        const handleLogin = () => {
            if (passwordInput.value === correctPassword) {
                localStorage.setItem('isAuthenticated', 'true');
                showApp();
                authMessage.classList.add('hidden');
            } else {
                authMessage.classList.remove('hidden');
            }
        };

        // Event Listeners
        form.addEventListener('submit', addOrUpdateEquipo);
        bulkImportButton.addEventListener('click', handleBulkImport);
        deleteSelectedButton.addEventListener('click', deleteSelectedEquipos);
        loginButton.addEventListener('click', handleLogin);
        passwordInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });
        selectAllCheckbox.addEventListener('change', (e) => {
            document.querySelectorAll('.equipo-checkbox').forEach(cb => {
                cb.checked = e.target.checked;
            });
        });
        logoutButton.addEventListener('click', handleLogout);

        // Inicializar la aplicación
        checkAuth();
    </script>
</body>
</html>