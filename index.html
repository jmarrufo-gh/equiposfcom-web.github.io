<script>
  const SHEET_ID = "1xw1VY3ojmDbbPD4q9ONPUSoMmPnhzyMaRdH6loaN-M0";
  const QUERY_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

  const searchInput = document.getElementById("searchInput");
  const searchButton = document.getElementById("searchButton");
  const tableBody = document.getElementById("equipmentTableBody");

  let allEquipos = [];
  let seriesIndex = {}; // <-- Índice por serie para búsquedas rápidas

  function renderTable(equipos) {
    tableBody.innerHTML = "";
    if (equipos.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-400">No se encontraron equipos.</td></tr>';
      return;
    }
    equipos.forEach((equipo) => {
      const row = document.createElement("tr");
      row.className = "border-b border-gray-600 last:border-0";
      row.innerHTML = `
        <td class="p-3">${equipo.tipo || ""}</td>
        <td class="p-3">${equipo.modelo || ""}</td>
        <td class="p-3">${equipo.serie || ""}</td>
        <td class="p-3">${equipo.proyecto || ""}</td>
      `;
      tableBody.appendChild(row);
    });
  }

  function parseGoogleSheetJSON(text) {
    const jsonText = text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1);
    return JSON.parse(jsonText);
  }

  async function fetchData() {
    try {
      const response = await fetch(QUERY_URL);
      const text = await response.text();
      const data = parseGoogleSheetJSON(text);

      const rows = data.table.rows;
      const cols = data.table.cols.map(c => c.label.toLowerCase().replace(/\s/g, ""));
      allEquipos = rows.map(row => {
        const obj = {};
        row.c.forEach((cell, idx) => {
          obj[cols[idx]] = cell ? cell.v : "";
        });
        return obj;
      });

      // Construimos el índice por serie
      seriesIndex = {};
      allEquipos.forEach(equipo => {
        const key = (equipo.serie || "").toLowerCase();
        if (!seriesIndex[key]) seriesIndex[key] = [];
        seriesIndex[key].push(equipo);
      });

      renderTable(allEquipos);
    } catch (e) {
      console.error("Error cargando datos:", e);
      tableBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-400">No se pudieron cargar los datos.</td></tr>';
    }
  }

  function handleSearch() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    if (searchTerm === "") {
      renderTable(allEquipos);
      return;
    }

    // Búsqueda rápida usando el índice
    const result = seriesIndex[searchTerm] || [];
    renderTable(result);
  }

  searchButton.addEventListener("click", handleSearch);

  fetchData();
</script>


