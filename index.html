<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Equipos - HP / FCOM</title>
    <style>
        :root {
            --hp-blue: #0071c5;
            --fcom-blue: #0096d6;
            --gradient-blue: #00b4d8;
            --hover-blue: #005a9e;
            --btn-bg: #f1f7ff;
            --border-light: #cfe2ff;
            --hover-light: #e0efff;
            --bg-soft: #f8f9fa;
            --warning: #ffc107;
            --white: #ffffff;
            --text-main: #2d2d2d;
            --text-muted: #6c757d;
            --error-color: #dc3545;
            --error-bg: #fff5f5;
            --success-color: #198754;
            --success-bg: #e6fffa;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--hp-blue) 0%, var(--gradient-blue) 100%);
            margin: 0; padding: 2rem; display: flex; justify-content: center; min-height: 100vh;
        }

        .container { 
            width: 100%; max-width: 900px; background: white; padding: 2.5rem; 
            border-radius: 12px; box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }

        /* LOADING OVERLAY */
        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95); display: none;
            flex-direction: column; justify-content: center; align-items: center; z-index: 9999;
        }
        .loading-overlay.active { display: flex; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--hp-blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* BANNERS */
        .header-logos { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border-light); padding-bottom: 1rem; margin-bottom: 1.5rem; }
        .logo-img { height: 45px; }

        .db-status { text-align: center; font-size: 0.85rem; padding: 0.6rem; background: var(--bg-soft); border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid var(--border-light); }
        
        .success-banner { background: var(--success-bg); border: 1px solid var(--success-color); color: #065f46; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: center; }
        .alert-banner { background: var(--error-bg); border: 1px solid var(--error-color); color: #842029; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: center; }

        /* SEARCH */
        .search-section { display: flex; gap: 1rem; margin-bottom: 2rem; }
        #serie-input { flex: 1; padding: 0.8rem 1.2rem; border: 2px solid var(--border-light); border-radius: 50px; font-size: 1rem; }
        #validate-button { padding: 0.8rem 2rem; background: var(--hp-blue); color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; }

        /* RESULT GRID */
        #result { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; background: var(--bg-soft); padding: 1.5rem; border-radius: 8px; }
        .main-serie { grid-column: 1/-1; text-align: center; font-size: 1.5rem; font-weight: 800; color: var(--hp-blue); border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .info-card { background: white; padding: 1rem; border-radius: 8px; border: 1px solid var(--border-light); text-align: center; }
        .info-card strong { display: block; font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px; }

        /* CHARTS */
        .chart-container { margin-top: 2rem; }
        .bar-wrapper { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .bar-label { width: 150px; font-size: 0.85rem; font-weight: bold; }
        .bar-bg { flex: 1; height: 25px; background: #eee; border-radius: 12px; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--fcom-blue); transition: width 1s ease; }
    </style>
</head>
<body>

    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <h2 style="color: var(--hp-blue);">Sincronizando Datos...</h2>
        <p id="load-msg">Conectando con el inventario de FCOM</p>
    </div>

    <div class="container">
        <div class="header-logos">
            <img src="https://fcom.cl/images/logo_simple.png" alt="FCOM" class="logo-img">
            <img src="https://upload.wikimedia.org/wikipedia/commons/a/ad/HP_logo_2012.svg" alt="HP" class="logo-img">
        </div>

        <h1 style="text-align: center; color: var(--hp-blue);">Gestión de Equipamiento PJUD</h1>
        
        <div class="db-status" id="db-status">Iniciando sistema...</div>

        <div class="search-section">
            <input type="text" id="serie-input" placeholder="Ingrese Número de Serie (ej: MXL...)">
            <button id="validate-button">Buscar</button>
        </div>

        <div id="result"></div>
        <div id="history-section" class="chart-container"></div>
    </div>

    <script>
        const el = id => document.getElementById(id);
        const urls = {
            inv: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTCZ0aHZlTcVbl13k7sBYGWh1JQr9KVzzaTT08GLbNKMD6Uy8hCmtb2mS_ehnSAJwegxVWt4E80rSrr/pub?gid=0&single=true&output=csv',
            hab: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTCZ0aHZlTcVbl13k7sBYGWh1JQr9KVzzaTT08GLbNKMD6Uy8hCmtb2mS_ehnSAJwegxVWt4E80rSrr/pub?gid=1180790714&single=true&output=csv',
            hist: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTCZ0aHZlTcVbl13k7sBYGWh1JQr9KVzzaTT08GLbNKMD6Uy8hCmtb2mS_ehnSAJwegxVWt4E80rSrr/pub?gid=1086366835&single=true&output=csv'
        };

        let db = { inv: new Map(), hab: new Map(), hist: [] };

        const clean = str => String(str || '').trim().toUpperCase().replace(/[^A-Z0-9]/g, '');

        function parseCSV(text) {
            const lines = text.split(/\r?\n/).filter(l => l.trim());
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            return lines.slice(1).map(line => {
                const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                let obj = {};
                headers.forEach((h, i) => obj[h] = (values[i] || '').trim().replace(/^"|"$/g, ''));
                return obj;
            });
        }

        async function init() {
            el('loading-overlay').classList.add('active');
            try {
                const [rInv, rHab, rHist] = await Promise.all([
                    fetch(urls.inv).then(r => r.text()),
                    fetch(urls.hab).then(r => r.text()),
                    fetch(urls.hist).then(r => r.text())
                ]);

                parseCSV(rInv).forEach(d => {
                    const s = clean(d['Serie'] || d['SERIE'] || d['Serial']);
                    if(s) db.inv.set(s, d);
                });

                parseCSV(rHab).forEach(d => {
                    const s = clean(d['serie principal antigua'] || d['SERIE PRINCIPAL ANTIGUA']);
                    if(s) db.hab.set(s, d);
                });

                db.hist = parseCSV(rHist);

                el('db-status').innerHTML = `Base de Datos: <span style="color:green;font-weight:bold;">Sincronizada</span> | Equipos: ${db.inv.size}`;
            } catch (e) {
                el('db-status').innerHTML = `<span style="color:red;">Error de conexión</span>`;
            }
            el('loading-overlay').classList.remove('active');
        }

        function search() {
            const s = clean(el('serie-input').value);
            if(!s) return;

            const eq = db.inv.get(s);
            const hb = db.hab.get(s);
            
            let banner = '';
            if (hb) {
                const fHab = hb['FECHA DE CAMBIO'] || hb['Fecha de Cambio'] || 'N/A';
                if (fHab === "N/A") {
                    const fInst = eq ? eq['Fecha de Instalacion'] : 'No Definida';
                    banner = `<div class="success-banner"><strong>✓ RECAMBIO ESTIPULADO</strong><br>Fecha de Instalación: ${fInst}</div>`;
                } else {
                    banner = `<div class="alert-banner"><strong>⚠️ ADVERTENCIA CRÍTICA</strong><br>Reemplazado el ${fHab}<br>Sucursal: ${hb['SUCURSAL']}</div>`;
                }
            }

            if (!eq && !hb) {
                el('result').innerHTML = `<p style="color:red; text-align:center; grid-column:1/-1;">Serie no encontrada.</p>`;
                return;
            }

            el('result').innerHTML = `
                ${banner}
                <div class="main-serie">SERIE: ${s}</div>
                <div class="info-card"><strong>Tipo</strong>${eq ? eq['Tipo'] : 'N/A'}</div>
                <div class="info-card"><strong>Modelo</strong>${eq ? eq['Modelo'] : 'N/A'}</div>
                <div class="info-card"><strong>Proyecto</strong>${eq ? eq['Proyecto'] : 'N/A'}</div>
                <div class="info-card"><strong>Estado</strong>${eq ? eq['Estado'] : 'N/A'}</div>
            `;

            // HISTORIAL
            const reports = db.hist.filter(h => clean(h['serie reportada'] || h['SERIE']) === s);
            if(reports.length > 0) {
                let html = `<h3>Historial de Reportes (${reports.length})</h3>`;
                const counts = {};
                reports.forEach(r => {
                    const n = r['Nivel 2'] || 'Otro';
                    counts[n] = (counts[n] || 0) + 1;
                });

                Object.entries(counts).forEach(([k, v]) => {
                    const pct = (v / reports.length) * 100;
                    html += `
                        <div class="bar-wrapper">
                            <div class="bar-label">${k} (${v})</div>
                            <div class="bar-bg"><div class="bar-fill" style="width:${pct}%"></div></div>
                        </div>`;
                });
                el('history-section').innerHTML = html;
            } else {
                el('history-section').innerHTML = '<p style="text-align:center; color:gray;">Sin reportes históricos.</p>';
            }
        }

        el('validate-button').onclick = search;
        el('serie-input').onkeyup = (e) => e.key === 'Enter' && search();
        init();
    </script>
</body>
</html>
